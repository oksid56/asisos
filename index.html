<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#2b2b2b"/>
  <meta name="license" content="CC0-1.0">
  <link rel="license" href="./LICENSE">
  <title>PWA Text Editor</title>

  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="./icon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="./style.css">

  <meta name="description" content="Simple offline-capable PWA text editor (standalone).">
</head>
<body>
  <header class="bar">
    <div class="left">
      <button id="newBtn" title="New">New</button>
      <button id="openBtn" title="Open">Open</button>
      <input id="fileInput" type="file" accept=".txt,text/plain" style="display:none">
      <button id="downloadBtn" title="Download">Download</button>
      <button id="clearBtn" title="Clear">Clear</button>
    </div>
    <div class="center">PWA Text Editor</div>
    <div class="right">
      <button id="installBtn" style="display:none">Install</button>
      <!-- New filename display -->
      <span id="filename" class="filename" title="Opened filename">untitled.txt</span>
      <span id="status" class="status">Saved</span>
    </div>
  </header>

  <main>
    <textarea id="editor" placeholder="Start typing..."></textarea>
  </main>

  <footer class="bar small">
    <label><input id="autosave" type="checkbox" checked> Autosave</label>
    <span class="spacer"></span>
    <small>Shortcuts: <strong>Ctrl/Cmd+S</strong> save Â· <strong>Ctrl/Cmd+O</strong> open</small>
  </footer>

  <script>
  /*
    pwa-editor/index.html (embedded JS)
    CC0 1.0 Universal - https://creativecommons.org/publicdomain/zero/1.0/
    SPDX-License-Identifier: CC0-1.0
    See ../LICENSE for the full legal text.
  */
  (function () {
    const editor = document.getElementById('editor');
    const status = document.getElementById('status');
    const filenameSpan = document.getElementById('filename');
    const autosaveCheckbox = document.getElementById('autosave');
    const downloadBtn = document.getElementById('downloadBtn');
    const openBtn = document.getElementById('openBtn');
    const fileInput = document.getElementById('fileInput');
    const newBtn = document.getElementById('newBtn');
    const clearBtn = document.getElementById('clearBtn');
    const installBtn = document.getElementById('installBtn');

    const STORAGE_KEY = 'pwa-editor-content-v1';
    const NAME_KEY = STORAGE_KEY + '-name';
    let saveTimeout = null;
    let deferredPrompt = null;
    let currentFilename = localStorage.getItem(NAME_KEY) || 'untitled.txt';

    // load content
    const load = () => {
      const content = localStorage.getItem(STORAGE_KEY) || '';
      editor.value = content;
      currentFilename = localStorage.getItem(NAME_KEY) || 'untitled.txt';
      filenameSpan.textContent = currentFilename;
      showStatus('Loaded');
    };

    // save content
    const save = (show = true) => {
      localStorage.setItem(STORAGE_KEY, editor.value);
      localStorage.setItem(NAME_KEY, currentFilename);
      if (show) showStatus('Saved');
    };

    const showStatus = (text) => {
      status.textContent = text;
      status.classList.add('flash');
      setTimeout(() => status.classList.remove('flash'), 700);
    };

    // autosave on typing (debounced)
    editor.addEventListener('input', () => {
      if (autosaveCheckbox.checked) {
        if (saveTimeout) clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => save(true), 600);
      } else {
        showStatus('Unsaved');
      }
    });

    // New file
    newBtn.addEventListener('click', () => {
      editor.value = '';
      currentFilename = 'untitled.txt';
      filenameSpan.textContent = currentFilename;
      save(true);
    });

    // Clear (keeps filename)
    clearBtn.addEventListener('click', () => {
      editor.value = '';
      save(true);
    });

    // Open (trigger file input)
    openBtn.addEventListener('click', () => fileInput.click());

    // File input change -> read file and set filename
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        editor.value = String(reader.result);
        currentFilename = file.name || 'untitled.txt';
        filenameSpan.textContent = currentFilename;
        save(true);
        // clear file input so same file can be re-selected later
        fileInput.value = '';
      };
      reader.onerror = () => showStatus('Error opening file');
      reader.readAsText(file);
    });

    // Download current content using currentFilename
    downloadBtn.addEventListener('click', () => {
      const content = editor.value || '';
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = currentFilename || 'download.txt';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showStatus('Downloaded');
    });

    // Keyboard shortcuts: Save (Ctrl/Cmd+S) and Open (Ctrl/Cmd+O)
    window.addEventListener('keydown', (e) => {
      const key = (e.key || '').toLowerCase();
      if ((e.ctrlKey || e.metaKey) && key === 's') {
        e.preventDefault();
        save(true);
      } else if ((e.ctrlKey || e.metaKey) && key === 'o') {
        e.preventDefault();
        fileInput.click();
      }
    });

    // Install prompt handling (if present elsewhere in your PWA code)
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-block';
    });
    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      deferredPrompt = null;
      installBtn.style.display = 'none';
      showStatus(choice.outcome === 'accepted' ? 'Installed' : 'Install dismissed');
    });

    // Initial load
    load();

    // Optional: register service worker if you have one (uncomment if needed)
    /*
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(() => {
        console.warn('Service worker registration failed');
      });
    }
    */
  })();
  </script>
</body>
</html>